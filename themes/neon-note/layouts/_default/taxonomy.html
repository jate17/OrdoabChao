{{ define "main" }}
<h1 class="h4 text-white mb-4">Tag: {{ .Title }}</h1>

{{/* 1) Prova standard: le pagine che Hugo passa al term */}}
{{ $pages := .Pages }}

{{/* 2) Fallback robusto: cerca tra tutte le RegularPages anche se tags è string o array, case-insensitive */}}
{{ if not (gt (len $pages) 0) }}
  {{ $needle := lower .Title }}
  {{ $acc := newScratch }}{{ $acc.Set "items" (slice) }}
  {{ range site.RegularPages }}
    {{ $raw := .Params.tags }}
    {{ if $raw }}
      {{/* Coerciamo a stringa e rendiamo lowercase; funziona sia per slice che per string */}}
      {{ $tagstr := (printf "%v" $raw) | lower }}
      {{ if in $tagstr $needle }}
        {{ $acc.Set "items" (append ($acc.Get "items") .) }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $pages = ($acc.Get "items") }}
{{ end }}

<p class="small text-mute mb-3">Pagine trovate: <strong>{{ len $pages }}</strong></p>

{{ if not (gt (len $pages) 0) }}
  <div class="alert alert-warning">Nessun contenuto con il tag “{{ .Title }}”.</div>
{{ else }}
  <div class="vstack gap-3">
    {{ range sort $pages "Date" "desc" }}
      <article class="card card-min h-100">
        <a class="stretched-link text-decoration-none" href="{{ .RelPermalink }}" aria-label="{{ .Title }}">
          <div class="card-body">
            <h2 class="h5 mb-1 link-quiet">{{ .Title }}</h2>
            <div class="meta small text-mute mb-2">
              {{ .Date.Format (or $.Site.Params.dateFormat "02 Jan 2006") }}
            </div>
            <p class="excerpt m-0">{{ .Summary | plainify }}</p>

            {{ with .Params.tags }}
            <div class="mt-2 d-flex flex-wrap gap-2">
              {{ range (uniq .) }}
                {{ $t := . }}
                {{ with site.GetPage (printf "/tags/%s" (urlize (lower $t))) }}
                  <a class="badge tag text-decoration-none" href="{{ .RelPermalink }}">{{ $t }}</a>
                {{ end }}
              {{ end }}
            </div>
            {{ end }}
          </div>
        </a>
      </article>
    {{ end }}
  </div>
{{ end }}
{{ end }}
